# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: digital-asset-processing-dotnet
version: 0.6.3
description: "A Porter bundle that deploys infrastructure and artifacts as a single distributed application. Uninstall removes the entire solution -- including infrastructure."
registry: ghcr.io/squillace 

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
# Here we use the PORTER_MIXIN line to optimize the build time of the bundle in dev usage.
dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - arm
  - az
  - jq
  

#outputs:
#  - name: webApiName
#    description: "The resulting name for the deployment of the webapi."
#    type: string
#  - name: functionName 
#    description: "The resulting name for the deployment of the Azure Function."
#    type: string
#  - name: cleanWebName
#    description: "The resulting name for the deployment of the webapi."
#    type: string
#  - name: cleanFuncName 
#    description: "The resulting name for the deployment of the Azure Function."
#    type: string
install:

  - az:
      description: "Logging into Azure..."  
      arguments:
        - login
      suppress-output: true
      flags:
        service-principal:
        username: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_ID}}'"
        password: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_SECRET}}'"
        tenant: "'{{bundle.credentials.AZURE_DEPLOY_TENANT_ID}}'"
        output: table
  - az: 
      description: "Setting the Azure subscription...."
      suppress-output: true
      arguments: 
        - "account" 
        - "set" 
      flags:
        subscription: "{{ bundle.credentials.AZURE_DEPLOY_SUBSCRIPTION_ID }}"
  - az:
      description: "Creating the Azure resource group if i t doesn't exist...."
      suppress-output: true
      arguments:
        - group
        - create
      flags:
        name: "'{{bundle.parameters.resourceGroup}}'"
        location: "'{{bundle.parameters.region}}'"
        output: table


#  - exec:
#      command: bash
#      description: "Using bash file to modify parameters."
#      suppress-output: true
#      arguments:
#        - ./modify-params.sh

  - az:
      description: "deploying the template imperatively"
      suppress-output: false
      arguments:
        - deployment
        - group
        - create
      flags:
        resource-group: "{{bundle.parameters.resourceGroup}}"
        name: rollout1
        template-file: '"src/arm/azuredeploy.json"'
        parameters: '"@src/arm/modified-parameters.json"'
        parameters: '"defaultResourceNamePrefix={{ bundle.parameters.defaultResourceNamePrefix }}"'

#      outputs:
#        - name: webApiName
#          jsonPath: "$.[*].parameters.webApiName.value"
#        - name: functionName 
#          jsonPath: "$.[*].parameters.functionAppName.value"
  - az:
      description: "Deploying the WebApi application..."
      suppress-output: false
      arguments:
        - webapp
        - deployment
        - source
        - config-zip
      flags:
        name: "{{bundle.parameters.webAppName}}"
        resource-group: "{{bundle.parameters.resourceGroup}}"
        src: webapi.zip
  - az:
      description: "Deploying the Azure Function application..."
      suppress-output: false
      arguments:
        - functionapp
        - deployment
        - source
        - config-zip
      flags:
        name: "{{bundle.parameters.functionAppName}}"
        resource-group: "{{bundle.parameters.resourceGroup}}"
        src: function.zip

upgrade:
  - exec:
      description: "Upgrade is not currently supported."
      command: bash
      flags:
        c: '"echo Not yet implemented."'

uninstall:
  - az:
      description: "Logging into Azure..."  
      arguments:
        - login
      suppress-output: true
      flags:
        service-principal:
        username: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_ID}}'"
        password: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_SECRET}}'"
        tenant: "'{{bundle.credentials.AZURE_DEPLOY_TENANT_ID}}'"
        output: table
  - az: 
      description: "Setting the Azure subscription...."
      suppress-output: true
      arguments: 
        - "account" 
        - "set" 
      flags:
        subscription: "{{ bundle.credentials.AZURE_DEPLOY_SUBSCRIPTION_ID }}"
  - az:
      description: "Deleting the entire resource group."
      arguments:
        - group 
        - delete
        - --yes
      flags:
        name: "{{bundle.parameters.resourceGroup}}"



# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
#  - name: kubeconfig
#    path: /root/.kube/config
#  - name: username
#    env: USERNAME
  - name: AZURE_DEPLOY_CLIENT_ID
    description: "The Azure Service Prinicipal application ID"
    env: CLIENT_ID
  - name: AZURE_DEPLOY_CLIENT_SECRET
    description: "The Azure Service Prinicipal application secret"
    env: CLIENT_SECRET
  - name: AZURE_DEPLOY_SUBSCRIPTION_ID
    description: "The deployment subscription ID"
    env: SUBSCRIPTION_ID
  - name: AZURE_DEPLOY_TENANT_ID
    description: "The deployment tenant ID"
    env: TENANT_ID
# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters
parameters:
  - name: region
    type: string
    default: westus2
  - name: resourceGroup
    type: string
    default: "zdemo"
  - name: defaultResourceNamePrefix
    type: string

