# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: github-accelerator
version: 0.3.3
description: "A Porter bundle that deploys all artifacts as a single distributed application."
# TODO: update the registry to your own, e.g. myregistry/porter-hello
tag: squillace/github-accelerator 

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
#dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - arm
  - az
  

install:
  - az:
      description: "Logging into Azure..."  
      arguments:
        - login
      flags:
        service-principal:
        username: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_ID}}'"
        password: "'{{bundle.credentials.AZURE_DEPLOY_CLIENT_SECRET}}'"
        tenant: "'{{bundle.credentials.AZURE_DEPLOY_TENANT_ID}}'"
        output: table
  - az: 
      description: "Setting the Azure subscription...."
      arguments: 
        - "account" 
        - "set" 
      flags:
        subscription: "{{ bundle.credentials.AZURE_DEPLOY_SUBSCRIPTION_ID }}"
  - az:
      description: "Creating the Azure resource group if it doesn't exist...."
      arguments:
        - group
        - create
      flags:
        name: "'{{bundle.parameters.resourceGroup}}'"
        location: "'{{bundle.parameters.region}}'"
        output: table

#  - arm:
#      description: "Install the Github Accelerator Azure Resource Manager template."
#      type: arm
#      template: "src/arm/azuredeploy.json"
#      name: github-accelerator
#      resourceGroup: "{{ bundle.parameters.resourceGroup }}"
#      parameters:
#        defaultResourceNamePrefix: "{{ bundle.parameters.defaultResourceNamePrefix}}"
#        storageAccountName: "{{bundle.parameters.storageAccountName}}"
#        cosmosAccountName: "{{bundle.parameters.cosmosAccountName}}"
#        cosmosCollectionName: "{{bundle.parameters.cosmosCollectionName}}"
#        cosmosDatabaseName: "{{bundle.parameters.cosmosDatabaseName}}"
#        applicationInsightsName: "{{bundle.parameters.applicationInsightsName}}"
#        functionAppName: "{{bundle.parameters.functionAppName}}"
#        webAppName: "{{bundle.parameters.webAppName}}"
#      outputs:
#        - name: "MYSQL_HOST"
#          key: "MYSQL_HOST"
  - az:
      description: "deploying the template imperatively"
      arguments:
        - deployment
        - group
        - create
      flags:
        resource-group: "{{bundle.parameters.resourceGroup}}"
        name: rollout-1
        template-file: '"src/arm/azuredeploy.json"'
        parameters: '"defaultResourceNamePrefix={{ bundle.parameters.defaultResourceNamePrefix}} storageAccountName={{bundle.parameters.storageAccountName}} cosmosAccountName={{bundle.parameters.cosmosAccountName}} cosmosCollectionName={{bundle.parameters.cosmosCollectionName}} cosmosDatabaseName={{bundle.parameters.applicationInsightsName}} functionAppName={{bundle.parameters.functionAppName}} webAppName={{bundle.parameters.webAppName}}"'
        debug: ""
upgrade:
  - exec:
      description: "World 2.0"
      command: ./helpers.sh
      arguments:
        - upgrade

uninstall:
  - exec:
      description: "Uninstall Hello World"
      command: ./helpers.sh
      arguments:
        - uninstall

# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
#  - name: kubeconfig
#    path: /root/.kube/config
#  - name: username
#    env: USERNAME
  - name: AZURE_DEPLOY_CLIENT_ID
    env: CLIENT_ID
  - name: AZURE_DEPLOY_CLIENT_SECRET
    env: CLIENT_SECRET
  - name: AZURE_DEPLOY_SUBSCRIPTION_ID
    env: SUBSCRIPTION_ID
  - name: AZURE_DEPLOY_TENANT_ID
    env: TENANT_ID
# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters
parameters:
#  - name: mysql_user
#    type: string
#    default: wordpress
  - name: region
    type: string
    default: westus2
  - name: resourceGroup
    type: string
    default: "zdemo"
  - name: defaultResourceNamePrefix
    type: string
    default: "zdemo"
  - name: storageAccountName
    type: string
    default: "zdemosta"
  - name: cosmosAccountName
    type: string
    default: "zdemocosmos"
  - name: cosmosCollectionName
    type: string
    default: "metadata"
  - name: cosmosDatabaseName
    type: string
    default: "media"
  - name: applicationInsightsName
    type: string
    default: "zdemoinsights"
  - name: functionAppName
    type: string
    default: "zdemofunc"
  - name: webAppName
    type: string
    default: "zdemoapi"